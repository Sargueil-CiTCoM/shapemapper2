/*-----------------------------------------------------------------------
 * This file is a part of ShapeMapper, and is licensed under the terms  *
 * of the MIT license. Copyright 2018 Steven Busan.                     *
 *----------------------------------------------------------------------*/

#include "gtest/gtest.h"
#include "MutationParser.cpp"
#include "MutationCounter.h"
#include "MutationCounter.cpp"

namespace BF = boost::filesystem;
using namespace mutation;
using namespace mutation_parser;
using namespace mutation_parser::detail;
using namespace mutation_counter;

std::string FILEPATH = __FILE__;
std::string BASEPATH = "";

BF::path getTestFileDir() {
    BF::path filedir;
    if (BASEPATH == "") {
        // data file location if explicit path to main shapemapper directory
        // not provided by test runner (assumes software location has not
        // changed since compilation)
        filedir = BF::path(FILEPATH).parent_path() / "files";
    } else {
        filedir = BF::path(BASEPATH) / "internals" / "cpp-src" / "test" / "files";
        //std::cout << "Using BASEPATH " << BASEPATH << " passed by argument" << std::endl;
    }
    BF::create_directory(filedir / "tmp");
    return filedir;
}

TEST(Count, MergedRead) {

    // FIXME: update all reads with tab separators, mapping_category, primer_pair, and mapping_depth

std::string sample_reads = R"(MERGED M01228:25:000000000-A1CW0:1:1101:14436:3447 0 137 11111111111111111111111111111111111111111111111111111111111111111111111111111111111001111111111111111111111111111110111111111111111111110 00000000000000000000000000000000010000000000000000000000000000000000000000000000000001000000000000000000000000000000100000000000000000000 32 34 "TCTTTCT" "JJJJJJJ" "complex_insertion" 82 86 "CAA" "JJJ" "multinuc_mismatch" 114 117 "G" "J" "complex_deletion_ambig"
MERGED M01228:25:000000000-A1CW0:1:1101:17761:3505 0 137 11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111101111111111111111111111111111111111111111110 00000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000001000000000000000000000000000000000000000000 75 77 "C" "J" "GC" 92 95 "TA" "JJ" "multinuc_mismatch"
MERGED M01228:25:000000000-A1CW0:1:1101:9748:3452 0 137 11100011111111111111000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110 00000000000000000000000000000000010000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 19 34 "T" "J" "complex_deletion_ambig" 47 49 "G" "J" "AG"
MERGED M01228:25:000000000-A1CW0:1:1101:11904:3509 0 137 11111111111111111111111111111111111111111111110000011111111111111111111111111111111111111111111111111111111111111111111111111111111111110 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
MERGED M01228:25:000000000-A1CW0:1:1101:17006:3548 0 137 11111111111111111111111000000000000000000111111111111111111111111111111111111111111111111111101111111111111111111111111111111111111111110 00000000000000000000000000000000000000000100000000000000001000000000000000000000010000000000001000000000000000000000000000000000000000000 22 42 "ACT" "JJJ" "complex_deletion" 57 59 "" "" "T-" 80 82 "T" "J" "CT" 92 95 "TA" "JJ" "multinuc_mismatch"
MERGED M01228:25:000000000-A1CW0:1:1101:11357:3532 0 137 00000000111111111111111100011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
MERGED M01228:25:000000000-A1CW0:1:1101:20661:3563 0 137 11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110 00000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000001000000001000000000000000000000000000000000 84 86 "A" "J" "GA" 93 95 "C" "J" "TC" 102 104 "" "" "T-_ambig"
MERGED M01228:25:000000000-A1CW0:1:1101:22018:3573 116 137 111111111111111111110 000000000000000000000
)";

    sample_reads = R"(MERGED	M01228:25:000000000-A1CW0:1:1101:14436:3447	0	137	INCLUDED	-999	11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111	11111111111111111111111111111111111111111111111111111111111111111111111111111111111001111111111111111111111111111110111111111111111111110	00000000000000000000000000000000010000000000000000000000000000000000000000000000000001000000000000000000000000000000100000000000000000000	32 34 "TCTTTCT" "JJJJJJJ" "complex_insertion" 82 86 "CAA" "JJJ" "multinuc_mismatch" 114 117 "G" "J" "complex_deletion_ambig"
)";

    std::string test_dir = getTestFileDir().string();
    std::vector<std::string> filenames;
    filenames.push_back(test_dir + "/tmp/tmp.mut");
    std::ofstream dummy(test_dir + "/tmp/tmp.mut");
    dummy << sample_reads;
    dummy.close();
    EXPECT_NO_THROW(
            countSelected(filenames,
                          137,
                          0,
                          "",
                          test_dir + "/tmp/tmp.counts.txt",
                          false, // generate and output histogram
                          false,
                          false,
                          false); //debug
    );

}


int main(int argc, char **argv) {
  ::testing::InitGoogleTest(&argc, argv);
  // set location of top-level shapemapper path so we can locate data files
  if (argc > 1){
      BASEPATH = argv[1];
  }
  return RUN_ALL_TESTS();
}

